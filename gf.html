<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åƒè§’å­è€è™æ©Ÿ - æ³¢å£«é “èŠ±ç”Ÿå¥¶æ²¹å ¡</title>
  <style>
    body {
      font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
      padding: 20px;
      max-width: 480px;
      margin: auto;
      background: #fff8e1;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    label, input, button {
      font-size: 1.2rem;
      margin-top: 10px;
      display: block;
      width: 100%;
    }
    input {
      padding: 8px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    button {
      padding: 10px;
      background: #ff9800;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    button:disabled {
      background: #ddd;
      cursor: not-allowed;
    }
    #message {
      margin-top: 10px;
      min-height: 1.5rem;
      font-weight: bold;
      color: #e65100;
    }
    #gameArea {
      margin-top: 30px;
      text-align: center;
    }
    #slots {
      font-size: 4rem;
      margin-bottom: 20px;
      letter-spacing: 15px;
      user-select: none;
    }
    #result {
      font-size: 1.3rem;
      margin: 15px 0;
      min-height: 1.5rem;
    }
    #playCount, #countdown {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>åƒè§’å­è€è™æ©Ÿ - æ³¢å£«é “èŠ±ç”Ÿå¥¶æ²¹å ¡</h1>

  <label for="codeInput">è«‹è¼¸å…¥éŠæˆ²ä»£ç¢¼ (å§“åæœ«å…©å­—+ä¸‰ç¢¼æ•¸å­—)ï¼š</label>
  <input id="codeInput" maxlength="5" placeholder="ä¾‹å¦‚ï¼šé˜¿æ˜899" autocomplete="off" />
  <button id="checkBtn">é©—è­‰ä»£ç¢¼</button>
  <p id="message"></p>

  <div id="gameArea" style="display:none;">
    <div id="slots">ğŸ” ğŸŸ ğŸ©</div>
    <button id="spinBtn" disabled>æ—‹è½‰æ‹‰æ¡¿ï¼</button>
    <p id="result"></p>
    <p>ä»Šæ—¥éŠç©æ¬¡æ•¸ï¼š<span id="playCount">0/1</span></p>
    <p>ä¸‹æ¬¡å¯ç©æ™‚é–“ï¼š<span id="countdown">00:00:00</span></p>
  </div>

<script>
  // TODO: é€™è£¡è«‹æ›æˆä½ çš„ GAS ç¶²å€ï¼ˆå·²å…¬é–‹éƒ¨ç½²çš„ exec ç¶²å€ï¼‰
  const scriptURL = 'https://script.google.com/macros/s/ä½ çš„GASä»£ç¢¼/exec';

  const codeInput = document.getElementById('codeInput');
  const checkBtn = document.getElementById('checkBtn');
  const message = document.getElementById('message');
  const gameArea = document.getElementById('gameArea');
  const slots = document.getElementById('slots');
  const spinBtn = document.getElementById('spinBtn');
  const result = document.getElementById('result');
  const playCountSpan = document.getElementById('playCount');
  const countdownSpan = document.getElementById('countdown');

  let playerCode = '';
  let canPlay = false;
  const jackpotIcon = 'ğŸ¥œ';
  const icons = ["ğŸ”", "ğŸŒ­", "ğŸŸ", "ğŸ©", "ğŸ•", "ğŸ¥“", "ğŸ¥ª", "ğŸ—", "ğŸ–", "ğŸŒ®", "ğŸŒ¯", "ğŸ¥™", "ğŸ™"];
  const jackpotChance = 0.02; // 2%

  // é©—è­‰æ ¼å¼ï¼šå…©å€‹ä¸­æ–‡å­— + ä¸‰ç¢¼æ•¸å­—
  function validateCode(code) {
    return /^[\u4e00-\u9fa5]{2}\d{3}$/.test(code);
  }

  async function checkEligibility() {
    const code = codeInput.value.trim();
    if (!validateCode(code)) {
      message.textContent = 'æ ¼å¼éŒ¯èª¤ï¼è«‹è¼¸å…¥å§“åæœ«å…©å­—+ä¸‰ç¢¼æ•¸å­—ï¼ˆä¾‹å¦‚ï¼šé˜¿æ˜899ï¼‰';
      return;
    }
    message.textContent = 'é©—è­‰ä¸­...';
    try {
      const res = await fetch(`${scriptURL}?action=check&code=${encodeURIComponent(code)}`);
      if(!res.ok) throw new Error('ç¶²è·¯éŒ¯èª¤');
      const data = await res.json();
      if (data.status === 'OK') {
        playerCode = code;
        message.textContent = 'é©—è­‰æˆåŠŸï¼Œå¯ä»¥é–‹å§‹éŠæˆ²ï¼';
        codeInput.disabled = true;
        checkBtn.disabled = true;
        gameArea.style.display = 'block';
        canPlay = true;
        updatePlayStatus();
      } else {
        message.textContent = data.message || 'é©—è­‰å¤±æ•—';
        canPlay = false;
      }
    } catch (err) {
      message.textContent = 'é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
    }
  }

  async function submitRecord(win, prize) {
    try {
      const formData = new FormData();
      formData.append('action', 'record');
      formData.append('code', playerCode);
      formData.append('win', win ? 'æ˜¯' : 'å¦');
      formData.append('prize', prize);
      // é€™è£¡ IP ç„¡æ³•å‰ç«¯å–å¾—ï¼ŒGAS ç«¯å¯æ”¹ç”¨ e.ip æˆ–é¡ä¼¼æ–¹å¼è¨˜éŒ„

      const res = await fetch(scriptURL, {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      if(data.status === 'recorded') {
        console.log('ç´€éŒ„æˆåŠŸ');
      }
    } catch (e) {
      console.error('ç´€éŒ„å¤±æ•—', e);
    }
  }

  function updatePlayStatus() {
    const today = new Date().toISOString().slice(0,10);
    const lastPlayDate = localStorage.getItem('lastPlayDate');
    let playCount = parseInt(localStorage.getItem('playCount') || '0', 10);

    if (lastPlayDate === today && playCount >= 1) {
      canPlay = false;
      spinBtn.disabled = true;
      spinBtn.textContent = 'ä»Šæ—¥å·²ç©é';
      startCountdownTimer();
    } else {
      canPlay = true;
      spinBtn.disabled = false;
      spinBtn.textContent = 'æ—‹è½‰æ‹‰æ¡¿ï¼';
      countdownSpan.textContent = '00:00:00';
    }
    playCountSpan.textContent = `${playCount}/1`;
  }

  function startCountdownTimer() {
    const now = new Date();
    const nextDay = new Date(now);
    nextDay.setHours(24,0,0,0);

    function update() {
      const diff = nextDay - new Date();
      if (diff <= 0) {
        localStorage.setItem('playCount', '0');
        localStorage.setItem('lastPlayDate', '');
        updatePlayStatus();
        clearInterval(timer);
        return;
      }
      const h = String(Math.floor(diff / 3600000)).padStart(2,'0');
      const m = String(Math.floor((diff % 3600000)/60000)).padStart(2,'0');
      const s = String(Math.floor((diff % 60000)/1000)).padStart(2,'0');
      countdownSpan.textContent = `${h}:${m}:${s}`;
    }
    update();
    const timer = setInterval(update, 1000);
  }

  async function spin() {
    if (!canPlay) return;

    spinBtn.disabled = true;
    result.textContent = 'è½‰å‹•ä¸­...';

    let spinCount = 0;
    const intervalId = setInterval(() => {
      slots.textContent = `${icons[randomIndex()]} ${icons[randomIndex()]} ${icons[randomIndex()]}`;
      spinCount++;
      if (spinCount > 15) {
        clearInterval(intervalId);

        const isJackpot = Math.random() < jackpotChance;
        if (isJackpot) {
          slots.textContent = `${jackpotIcon} ${jackpotIcon} ${jackpotIcon}`;
          result.textContent = 'æ­å–œä¸­çï¼ä½ å¾—åˆ°æ³¢å£«é “èŠ±ç”Ÿå¥¶æ²¹å ¡ï¼';
          submitRecord(true, 'æ³¢å£«é “èŠ±ç”Ÿå¥¶æ²¹å ¡');
          alert('ğŸ‰ æ­å–œä½ ä¸­çï¼æ³¢å£«é “èŠ±ç”Ÿå¥¶æ²¹å ¡å·²ç¶“ç‚ºä½ ä¿ç•™ï¼');
        } else {
          result.textContent = 'å¾ˆéºæ†¾ï¼Œæœªä¸­çï¼Œè¬è¬åƒèˆ‡ï¼';
          submitRecord(false, 'æœªä¸­ç');
        }

        // æ›´æ–°éŠç©æ¬¡æ•¸
        const today = new Date().toISOString().slice(0,10);
        localStorage.setItem('lastPlayDate', today);
        localStorage.setItem('playCount', '1');
        updatePlayStatus();
      }
    }, 100);

  }

  function randomIndex() {
    return Math.floor(Math.random() * icons.length);
  }

  checkBtn.addEventListener('click', checkEligibility);
  spinBtn.addEventListener('click', spin);
</script>
</body>
</html>
