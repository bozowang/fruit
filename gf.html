<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>吃角子老虎機 - 波士頓花生奶油堡</title>
  <style>
    /* 你的CSS樣式 */
  </style>
</head>
<body>
  <div>
    <h1>吃角子老虎機 - 波士頓花生奶油堡</h1>
    <label>請輸入遊戲代碼 (姓名末兩字+三碼數字)：</label>
    <input id="codeInput" maxlength="5" placeholder="例如：阿明899" />
    <button id="checkBtn">驗證代碼</button>
    <p id="message"></p>
    
    <div id="gameArea" style="display:none;">
      <div id="slots" style="font-size: 4rem; margin: 20px 0;">🍔 🍟 🍩</div>
      <button id="spinBtn">旋轉拉桿！</button>
      <p id="result"></p>
      <p>今日遊玩次數：<span id="playCount">0/1</span></p>
      <p>下次可玩時間：<span id="countdown">00:00:00</span></p>
    </div>
  </div>

<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbzCRZZrLCkadn_nRRvXfsSegqn-tsBqDTR-wicMUFLk-AhOTlYItIr3EZud_lETOaXk/exec';

  const codeInput = document.getElementById('codeInput');
  const checkBtn = document.getElementById('checkBtn');
  const message = document.getElementById('message');
  const gameArea = document.getElementById('gameArea');
  const slots = document.getElementById('slots');
  const spinBtn = document.getElementById('spinBtn');
  const result = document.getElementById('result');
  const playCountSpan = document.getElementById('playCount');
  const countdownSpan = document.getElementById('countdown');

  let playerCode = '';
  let canPlay = false;
  const jackpotIcon = '🥜';
  const icons = ["🍔", "🌭", "🍟", "🍩", "🍕", "🥓", "🥪", "🍗", "🍖", "🌮", "🌯", "🥙", "🍙"];
  const jackpotChance = 0.02; // 2%

  function validateCode(code) {
    return /^[\u4e00-\u9fa5]{2}\d{3}$/.test(code);
  }

  async function checkEligibility() {
    const code = codeInput.value.trim();
    if (!validateCode(code)) {
      message.textContent = '格式錯誤！請輸入姓名末兩字+三碼數字（例如：阿明899）';
      return;
    }
    message.textContent = '驗證中...';
    try {
      const res = await fetch(`${scriptURL}?action=check&code=${encodeURIComponent(code)}`);
      const data = await res.json();
      if (data.status === 'OK') {
        playerCode = code;
        message.textContent = '驗證成功，可以開始遊戲！';
        codeInput.disabled = true;
        checkBtn.disabled = true;
        gameArea.style.display = 'block';
        canPlay = true;
        updatePlayStatus();
      } else {
        message.textContent = data.message || '驗證失敗';
        canPlay = false;
      }
    } catch (err) {
      message.textContent = '連線錯誤，請稍後再試';
    }
  }

  async function submitRecord(win, prize) {
    try {
      const formData = new FormData();
      formData.append('action', 'record');
      formData.append('code', playerCode);
      formData.append('ip', 'unknown'); 
      formData.append('win', win ? '是' : '否');
      formData.append('prize', prize);

      const res = await fetch(scriptURL, { method: 'POST', body: formData });
      const data = await res.json();
      if(data.status === 'recorded') {
        console.log('紀錄成功');
      }
    } catch (e) {
      console.error('紀錄失敗', e);
    }
  }

  function updatePlayStatus() {
    const today = new Date().toISOString().slice(0,10);
    const lastPlayDate = localStorage.getItem('lastPlayDate');
    let playCount = parseInt(localStorage.getItem('playCount') || '0', 10);

    if (lastPlayDate === today && playCount >= 1) {
      canPlay = false;
      spinBtn.disabled = true;
      spinBtn.textContent = '今日已玩過';
      startCountdownTimer();
    } else {
      canPlay = true;
      spinBtn.disabled = false;
      spinBtn.textContent = '旋轉拉桿！';
      countdownSpan.textContent = '00:00:00';
    }
    playCountSpan.textContent = `${playCount}/1`;
  }

  function startCountdownTimer() {
    const now = new Date();
    const nextDay = new Date(now);
    nextDay.setHours(24,0,0,0);

    function update() {
      const diff = nextDay - new Date();
      if (diff <= 0) {
        localStorage.setItem('playCount', '0');
        localStorage.setItem('lastPlayDate', '');
        updatePlayStatus();
        clearInterval(timer);
        return;
      }
      const h = String(Math.floor(diff / 3600000)).padStart(2,'0');
      const m = String(Math.floor((diff % 3600000)/60000)).padStart(2,'0');
      const s = String(Math.floor((diff % 60000)/1000)).padStart(2,'0');
      countdownSpan.textContent = `${h}:${m}:${s}`;
    }
    update();
    const timer = setInterval(update, 1000);
  }

  async function spin() {
    if (!canPlay) return;

    spinBtn.disabled = true;
    result.textContent = '轉動中...';
    let spinCount = 0;

    const intervalId = setInterval(() => {
      slots.textContent = `${icons[randomIndex()]} ${icons[randomIndex()]} ${icons[randomIndex()]}`;
      spinCount++;
      if (spinCount > 15) {
        clearInterval(intervalId);
        const isJackpot = Math.random() < jackpotChance;
        if (isJackpot) {
          slots.textContent = `${jackpotIcon} ${jackpotIcon} ${jackpotIcon}`;
          result.textContent = '恭喜中獎！你得到波士頓花生奶油堡！';
          submitRecord(true, '波士頓花生奶油堡');
          alert('🎉 恭喜你中獎！波士頓花生奶油堡已經為你保留！');
        } else {
          result.textContent = '很遺憾，未中獎，謝謝參與！';
          submitRecord(false, '未中獎');
        }
        const today = new Date().toISOString().slice(0,10);
        localStorage.setItem('lastPlayDate', today);
        localStorage.setItem('playCount', '1');
        updatePlayStatus();
      }
    }, 100);
  }

  function randomIndex() {
    return Math.floor(Math.random() * icons.length);
  }

  checkBtn.addEventListener('click', checkEligibility);
  spinBtn.addEventListener('click', spin);
</script>
</body>
</html>
