<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åƒè§’å­è€è™æ©Ÿ - æ³¢å£«é “èŠ±ç”Ÿå¥¶æ²¹å ¡</title>
  <style>
    /* ä½ çš„CSSæ¨£å¼ */
  </style>
</head>
<body>
  <div>
    <h1>åƒè§’å­è€è™æ©Ÿ - æ³¢å£«é “èŠ±ç”Ÿå¥¶æ²¹å ¡</h1>
    <label>è«‹è¼¸å…¥éŠæˆ²ä»£ç¢¼ (å§“åæœ«å…©å­—+ä¸‰ç¢¼æ•¸å­—)ï¼š</label>
    <input id="codeInput" maxlength="5" placeholder="ä¾‹å¦‚ï¼šé˜¿æ˜899" />
    <button id="checkBtn">é©—è­‰ä»£ç¢¼</button>
    <p id="message"></p>
    
    <div id="gameArea" style="display:none;">
      <div id="slots" style="font-size: 4rem; margin: 20px 0;">ğŸ” ğŸŸ ğŸ©</div>
      <button id="spinBtn">æ—‹è½‰æ‹‰æ¡¿ï¼</button>
      <p id="result"></p>
      <p>ä»Šæ—¥éŠç©æ¬¡æ•¸ï¼š<span id="playCount">0/1</span></p>
      <p>ä¸‹æ¬¡å¯ç©æ™‚é–“ï¼š<span id="countdown">00:00:00</span></p>
    </div>
  </div>

<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbzCRZZrLCkadn_nRRvXfsSegqn-tsBqDTR-wicMUFLk-AhOTlYItIr3EZud_lETOaXk/exec';

  const codeInput = document.getElementById('codeInput');
  const checkBtn = document.getElementById('checkBtn');
  const message = document.getElementById('message');
  const gameArea = document.getElementById('gameArea');
  const slots = document.getElementById('slots');
  const spinBtn = document.getElementById('spinBtn');
  const result = document.getElementById('result');
  const playCountSpan = document.getElementById('playCount');
  const countdownSpan = document.getElementById('countdown');

  let playerCode = '';
  let canPlay = false;
  const jackpotIcon = 'ğŸ¥œ';
  const icons = ["ğŸ”", "ğŸŒ­", "ğŸŸ", "ğŸ©", "ğŸ•", "ğŸ¥“", "ğŸ¥ª", "ğŸ—", "ğŸ–", "ğŸŒ®", "ğŸŒ¯", "ğŸ¥™", "ğŸ™"];
  const jackpotChance = 0.02; // 2%

  function validateCode(code) {
    return /^[\u4e00-\u9fa5]{2}\d{3}$/.test(code);
  }

  async function checkEligibility() {
    const code = codeInput.value.trim();
    if (!validateCode(code)) {
      message.textContent = 'æ ¼å¼éŒ¯èª¤ï¼è«‹è¼¸å…¥å§“åæœ«å…©å­—+ä¸‰ç¢¼æ•¸å­—ï¼ˆä¾‹å¦‚ï¼šé˜¿æ˜899ï¼‰';
      return;
    }
    message.textContent = 'é©—è­‰ä¸­...';
    try {
      const res = await fetch(`${scriptURL}?action=check&code=${encodeURIComponent(code)}`);
      const data = await res.json();
      if (data.status === 'OK') {
        playerCode = code;
        message.textContent = 'é©—è­‰æˆåŠŸï¼Œå¯ä»¥é–‹å§‹éŠæˆ²ï¼';
        codeInput.disabled = true;
        checkBtn.disabled = true;
        gameArea.style.display = 'block';
        canPlay = true;
        updatePlayStatus();
      } else {
        message.textContent = data.message || 'é©—è­‰å¤±æ•—';
        canPlay = false;
      }
    } catch (err) {
      message.textContent = 'é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
    }
  }

  async function submitRecord(win, prize) {
    try {
      const formData = new FormData();
      formData.append('action', 'record');
      formData.append('code', playerCode);
      formData.append('ip', 'unknown'); 
      formData.append('win', win ? 'æ˜¯' : 'å¦');
      formData.append('prize', prize);

      const res = await fetch(scriptURL, { method: 'POST', body: formData });
      const data = await res.json();
      if(data.status === 'recorded') {
        console.log('ç´€éŒ„æˆåŠŸ');
      }
    } catch (e) {
      console.error('ç´€éŒ„å¤±æ•—', e);
    }
  }

  function updatePlayStatus() {
    const today = new Date().toISOString().slice(0,10);
    const lastPlayDate = localStorage.getItem('lastPlayDate');
    let playCount = parseInt(localStorage.getItem('playCount') || '0', 10);

    if (lastPlayDate === today && playCount >= 1) {
      canPlay = false;
      spinBtn.disabled = true;
      spinBtn.textContent = 'ä»Šæ—¥å·²ç©é';
      startCountdownTimer();
    } else {
      canPlay = true;
      spinBtn.disabled = false;
      spinBtn.textContent = 'æ—‹è½‰æ‹‰æ¡¿ï¼';
      countdownSpan.textContent = '00:00:00';
    }
    playCountSpan.textContent = `${playCount}/1`;
  }

  function startCountdownTimer() {
    const now = new Date();
    const nextDay = new Date(now);
    nextDay.setHours(24,0,0,0);

    function update() {
      const diff = nextDay - new Date();
      if (diff <= 0) {
        localStorage.setItem('playCount', '0');
        localStorage.setItem('lastPlayDate', '');
        updatePlayStatus();
        clearInterval(timer);
        return;
      }
      const h = String(Math.floor(diff / 3600000)).padStart(2,'0');
      const m = String(Math.floor((diff % 3600000)/60000)).padStart(2,'0');
      const s = String(Math.floor((diff % 60000)/1000)).padStart(2,'0');
      countdownSpan.textContent = `${h}:${m}:${s}`;
    }
    update();
    const timer = setInterval(update, 1000);
  }

  async function spin() {
    if (!canPlay) return;

    spinBtn.disabled = true;
    result.textContent = 'è½‰å‹•ä¸­...';
    let spinCount = 0;

    const intervalId = setInterval(() => {
      slots.textContent = `${icons[randomIndex()]} ${icons[randomIndex()]} ${icons[randomIndex()]}`;
      spinCount++;
      if (spinCount > 15) {
        clearInterval(intervalId);
        const isJackpot = Math.random() < jackpotChance;
        if (isJackpot) {
          slots.textContent = `${jackpotIcon} ${jackpotIcon} ${jackpotIcon}`;
          result.textContent = 'æ­å–œä¸­çï¼ä½ å¾—åˆ°æ³¢å£«é “èŠ±ç”Ÿå¥¶æ²¹å ¡ï¼';
          submitRecord(true, 'æ³¢å£«é “èŠ±ç”Ÿå¥¶æ²¹å ¡');
          alert('ğŸ‰ æ­å–œä½ ä¸­çï¼æ³¢å£«é “èŠ±ç”Ÿå¥¶æ²¹å ¡å·²ç¶“ç‚ºä½ ä¿ç•™ï¼');
        } else {
          result.textContent = 'å¾ˆéºæ†¾ï¼Œæœªä¸­çï¼Œè¬è¬åƒèˆ‡ï¼';
          submitRecord(false, 'æœªä¸­ç');
        }
        const today = new Date().toISOString().slice(0,10);
        localStorage.setItem('lastPlayDate', today);
        localStorage.setItem('playCount', '1');
        updatePlayStatus();
      }
    }, 100);
  }

  function randomIndex() {
    return Math.floor(Math.random() * icons.length);
  }

  checkBtn.addEventListener('click', checkEligibility);
  spinBtn.addEventListener('click', spin);
</script>
</body>
</html>
