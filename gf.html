<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>水果吃角子老虎機</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; }
    input, button { font-size: 1.2em; margin: 0.5em; }
    #result { font-size: 1.5em; margin-top: 1em; color: green; }
    #error { font-size: 1.2em; margin-top: 1em; color: red; }
  </style>
</head>
<body>
  <h1>水果吃角子老虎機</h1>
  <p>請輸入你的代碼參加遊戲：</p>
  <input type="text" id="codeInput" placeholder="輸入代碼">
  <button onclick="startGame()">開始遊戲</button>

  <div id="result"></div>
  <div id="error"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwSc5XiIWEsSIIKdwgFn1d20wBMJqJUFAE5BEoaQbQjH1ZLab4qyWGkYSNnTftxfd4/exec';

    async function startGame() {
      const code = document.getElementById("codeInput").value.trim();
      const resultDiv = document.getElementById("result");
      const errorDiv = document.getElementById("error");
      resultDiv.textContent = '';
      errorDiv.textContent = '';

      if (!code) {
        errorDiv.textContent = "請輸入代碼！";
        return;
      }

      // 第一步：檢查代碼
      try {
        const checkRes = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'check', code })
        });
        const checkData = await checkRes.json();

        if (checkData.status !== 'ok') {
          errorDiv.textContent = checkData.message || "代碼錯誤，無法參加遊戲。";
          return;
        }

        // 模擬轉輪結果（20種圖案）
        const icons = ['🍎','🍊','🍇','🍉','🍌','🍍','🥝','🍒','🍓','🍑','🥥','🍈','🍐','🥭','🍋','🫐','🍏','🌽','🥕','🧄'];
        const r1 = Math.floor(Math.random() * icons.length);
        const r2 = Math.floor(Math.random() * icons.length);
        const r3 = Math.floor(Math.random() * icons.length);
        const win = (r1 === r2 && r2 === r3);
        const prize = win ? "波士頓花生奶油堡" : "";
        const resultStr = icons[r1] + " " + icons[r2] + " " + icons[r3];

        resultDiv.textContent = win 
          ? `🎉 恭喜中獎！${resultStr}，獲得：${prize}`
          : `未中獎：${resultStr}`;

        // 第二步：記錄結果
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'record',
            code: code,
            win: win,
            prize: prize,
            result: resultStr
          })
        });

      } catch (err) {
        console.error(err);
        errorDiv.textContent = "發生錯誤，請稍後再試。";
      }
    }
  </script>
</body>
</html>
